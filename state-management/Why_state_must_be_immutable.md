# 상태가 불변해야 하는 이유 (with React)

불변성은, 변경 가능한 상태를 여러 곳에서 공유하게 됨으로써 발생하는 여러 가지 문제를 해결하기 위함이다.

## 리액트의 상태 불변성

리액트의 상태가 불변해야 하는 이유는 리액트에서 상태 업데이트를 하는 원리 때문이다.

리액트는 상태가 변경되면, 컴포넌트를 리렌더링한다.

이때 리액트는 상태값을 업데이트 할 때 얕은 비교를 수행한다.  
즉, 상태 객체의 속성 값 하나하나를 비교하는게 아니라 상태 객체의 참조 값만을 비교하여 상태 변화를 감지한다.

따라서 원본 상태 객체의 속성 값을 직접 변경하게 되면,  
상태 객체의 참조 값이 변하지 않아 리액트는 변경사항을 인식하지 못한다.

`state.number = action.number;`

> 상태 객체의 속성을 직접 변경하였으므로 참조값이 변하지 않아 인식하지 못함.

때문에 새로운 상태 객체를 생성하여 새로운 참조값을 만들어 상태를 업데이트 해야 한다.

즉 원본 상태의 불변성을 지켜주고 새로운 상태를 생성 함으로써, 리액트가 상태 변화를 감지하도록 해주어야 한다.

## Immer (with Redux-Toolkit)

따라서 상태 변경이 필요할 시,  
원본 상태 객체는 불변해야 하므로 원본 상태 객체를 복사한 후 복사본에서 상태를 변경해주어야 한다.

만약 객체의 깊이가 1레벨 이라면, 스프레드 문법을 사용하여 쉽게 복사할 수 있지만,  
객체의 깊이가 2레벨 이상이라면 깊은 복사를 위한 추가적인 코드 작성이 필요하다.

이때 사용가능한 immer.js는 불변성 유지를 도와주는 라이브러리이며, immer를 사용하면 손쉬운 불변성 관리가 가능하다.

immer에서 제공하는 produce 메소드를 사용하면, 내부적으로 원본 상태 객체를 복사해주기 때문에 손쉽게 상태 변경이 가능하다.

```javascript
import produce from "immer";

const state = {
  number: 1,
  immutable: 2,
};

const newState = produce(state, (draft) => {
  draft.number += 1;
});

console.log(newState);
// { number: 2, immutable: 2 }
```

produce 함수의 첫 번쨰 파라미터는 수정하고 싶은 상태 객체, 두 번째 파라미터는 상태를 어떻게 업데이트할 지 정의하는 함수다.

Redux Toolkit의 `createReducer`, `createSlice` API는 자동으로 Immer를 내부적으로 사용하기 때문에 간단하게 원본 상태 객체의 불변성을 보장해 주어 리듀서 구현을 단순화 시켜준다.
